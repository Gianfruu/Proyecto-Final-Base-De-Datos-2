<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lista de Productos</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <%- include('../partials/navbar') %>
  <div class="container">
    <h1>Productos</h1>
    

    <form method="GET" action="/productos" style="margin-bottom: 30px; display: flex; gap: 10px;">
      <input 
        type="text" 
        name="keyword" 
        class="search-input"
        placeholder="Buscar por nombre o c√≥digo" 
        value="<%= keyword %>" 
      />

      <select name="limit">
        <option value="5" <%= limit == 5 ? 'selected' : '' %>>5</option>
        <option value="10" <%= limit == 10 ? 'selected' : '' %>>10</option>
        <option value="20" <%= limit == 20 ? 'selected' : '' %>>20</option>
        <option value="50" <%= limit == 50 ? 'selected' : '' %>>50</option>
      </select>

      <button type="submit">üîç Buscar</button>
    </form>

    <%
      function buildSortLink(field) {
        let newOrder = 'asc';
        if (sort === field && order === 'asc') {
          newOrder = 'desc';
        }

        const params = new URLSearchParams({
          keyword,
          page: 1,
          sort: field,
          order: newOrder,
          limit
        });

        return `?${params.toString()}`;
      }
    %>

    <table class="product-table">
      <thead>
        <tr>

          <th class="col-nombre">
            <a class="sortable" href="<%= buildSortLink('nombre') %>">
              Nombre
                <% if (sort === 'nombre') { %>
                  <%= order === 'asc' ? '‚ñ≤' : '‚ñº' %>
                <% } %>
            </a>
          </th>
          
          <th>
            <a class="sortable" href="<%= buildSortLink('codigo') %>">
              C√≥digo
                <% if (sort === 'codigo') { %>
                  <%= order === 'asc' ? '‚ñ≤' : '‚ñº' %>
                <% } %>
            </a>
          </th>

          <th class="col-categoria">
            <a class="sortable" href="<%= buildSortLink('categoria') %>">
              Categor√≠a
                <% if (sort === 'categoria') { %>
                <%= order === 'asc' ? '‚ñ≤' : '‚ñº' %>
                <% } %>
            </a>
          </th>


          <th>
            <a href="<%= buildSortLink('precio') %>">
              Precio
                <% if (sort === 'precio') { %>
                <%= order === 'asc' ? '‚ñ≤' : '‚ñº' %>
                <% } %>
            </a>
          </th>

          <th>
            <a href="<%= buildSortLink('stockActual') %>">
              Stock
                <% if (sort === 'stockActual') { %>
                <%= order === 'asc' ? '‚ñ≤' : '‚ñº' %>
                <% } %>
            </a>
          </th>
          <th class="detalle-header">Detalle</th>
          <th class="detalle-header">Acciones</th>
          <th class="detalle-header">Actualizar</th>         
        </tr>
      </thead>
      <tbody>
        
        <% productos.forEach(p => { %>          
          <tr>            
            <td class="col-nombre"><%= p.nombre %></td>
            <td><%= p.codigo %></td>
            <td class="col-categoria"><%= p.categoria %></td>
            <td>$<%= p.precio.toFixed(2) %></td>
            <td><%= p.stockActual %></td>
            <td><a href="/productos/<%= p._id %>?page=<%= meta.page %>&limit=<%= limit %>&keyword=<%= keyword %>&sort=<%= sort %>&order=<%= order %>" class="detail-button">Detalle</a></td>

            <td>              
              <form 
                method="POST" 
                action="/productos/<%= p._id %>?_method=DELETE&page=<%= meta.page %>&limit=<%= limit %>&keyword=<%= keyword %>&sort=<%= sort %>&order=<%= order %>" 
                style="display:inline;"
              >
                <button 
                  type="submit" 
                  class="delete-button" 
                  onclick="return confirm('¬øEst√°s seguro de que deseas eliminar este producto?');"
                >
                  Eliminar
                </button>
              </form>
            </td>


             <td>
              <a href="/productos/<%= p._id %>/editar" class="update-button">üñãÔ∏è Editar</a>  
             </td>



          </tr> 
        <% }) %>        
      </tbody>
    </table>

    <div class="pagination">
      <% if (meta.hasPrev) { %>
        <a href="?page=<%= meta.page - 1 %>&keyword=<%= keyword %>&sort=<%= sort %>&order=<%= order %>&limit=<%= limit %>">‚Üê Anterior</a>
      <% } %>

      <span>P√°gina <%= meta.page %> de <%= meta.pages %></span>

      <% if (meta.hasNext) { %>
        <a href="?page=<%= meta.page + 1 %>&keyword=<%= keyword %>&sort=<%= sort %>&order=<%= order %>&limit=<%= limit %>">Siguiente ‚Üí</a>
      <% } %>
    </div>
  </div>
</body>
</html>
